<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Kornaros">
<meta name="dcterms.date" content="2024-12-13">

<title>Basic OSS Architecture</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="basic_oss_files/libs/clipboard/clipboard.min.js"></script>
<script src="basic_oss_files/libs/quarto-html/quarto.js"></script>
<script src="basic_oss_files/libs/quarto-html/popper.min.js"></script>
<script src="basic_oss_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="basic_oss_files/libs/quarto-html/anchor.min.js"></script>
<link href="basic_oss_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="basic_oss_files/libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="basic_oss_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="basic_oss_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="basic_oss_files/libs/bootstrap/bootstrap-973236bd072d72a04ee9cd82dcc9cb29.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Basic OSS Architecture</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Research</div>
    <div class="quarto-category">Ongoing</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Kornaros </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 13, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The purpose of this project is to showcase the power of open source tools when designing a data and analytics system. I will be walking through my workflow step by step, and including both images, code, and notes.</p>
<section id="project-initialization" class="level2">
<h2 class="anchored" data-anchor-id="project-initialization">Project Initialization</h2>
<section id="first-steps" class="level3">
<h3 class="anchored" data-anchor-id="first-steps">First Steps</h3>
<p>Let’s start from scratch, a blank <a href="https://www.code.visualstudio.com/">VS Code</a> IDE. We’ll do everything from the command line, so make sure to open that up (Ctrl-`).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/blank_vscode_ide.png" class="img-fluid figure-img"></p>
<figcaption>Blank IDE</figcaption>
</figure>
</div>
<p>First, I begin in my home directory. Then, I change to my Documents directory, which I use for all of my projects. This is where I’ll begin creating the project directory and initializing the subsequent tools. As you’ll see below, I first initialize the uv repository and change into it. Then, I create the repo on GitHub (because I like generating the license then), pull (my global is set to merge), commit, and make the initial push. Then, I will initialize the Quarto project, to begin documentation as I work.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/uv_gh_init.png" class="img-fluid figure-img"></p>
<figcaption>Project and Repo Initialization</figcaption>
</figure>
</div>
<p><img src="images/uv_base_env.png" class="img-fluid" alt="Basic Uv Environment"> You can see here that I have both <code>jupyter</code> and <code>dbt</code> already installed. That’s because <code>uv</code> installs tools system wide, because these are typically used from the CLI. That being said, some CLI tools (like Quarto and DuckDB) in my experience don’t work with <code>uv</code> because it doesn’t install their executables.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/gh_remote_add.png" class="img-fluid figure-img"></p>
<figcaption>Git Remote Add and Pull</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/first_commit.png" class="img-fluid figure-img"></p>
<figcaption>First Commit</figcaption>
</figure>
</div>
<section id="adding-quarto" class="level4">
<h4 class="anchored" data-anchor-id="adding-quarto">Adding Quarto</h4>
<p>Now, it’s time to setup some extra functionality in the project. I’m going to be using Quarto for documentation, so I’ll run <code>quarto create project</code>. To learn more about Quarto and configuring your documentation in projects, checkout my <a href="https://ChrisKornaros.github.io/guides/quarto/">guide</a>. It’s a fantastic tool for building beautiful, robust documentation, even in enterprise production environments. Consider it for future papers, websites, dashboards, and reports.</p>
<p>That being said, if you are ever taking screenshots of your work and want to quickly move them into your images folder, you can do so from the CLI.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/quarto_init.png" class="img-fluid figure-img"></p>
<figcaption>Quarto Project Initialization</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/mv_cli_images.png" class="img-fluid figure-img"></p>
<figcaption>Moving Images from the CLI</figcaption>
</figure>
</div>
<p>Now that you’ve done that, it’s time to start adding dependencies. As a heads up, don’t be surprised if you don’t see the <code>uv.lock</code> or the <code>.venv</code> objects in your directory right away, because <code>uv</code> doesn’t create those until you add dependencies. Simply run <code>uv add</code> to start adding them. Afterwards, the necessary requirements and lock files will update automatically. If you want to learn more, checkout my <a href="https://ChrisKornaros.github.io/guides/uv">uv guide</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/uv_add.png" class="img-fluid figure-img"></p>
<figcaption>Add Dependencies with uv</figcaption>
</figure>
</div>
</section>
<section id="the-pyproject.toml-file" class="level4">
<h4 class="anchored" data-anchor-id="the-pyproject.toml-file">The Pyproject.toml file</h4>
<p>Once that’s done, uv will update the general dependencies in the <code>pyproject.toml</code> file and the specific versions in <code>uv.lock</code> (think requirements.txt on steroids). The nice thing here, it only lists the actual package you needed, not everything else that the package requires. So, when you want to remove packages you can simply use <code>uv remove</code> and the individual package names listed here to remove <em>everything</em> in your environment. There’s an example below.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>[project]</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> <span class="st">"basic-oss-architecture"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>version <span class="op">=</span> <span class="st">"0.1.0"</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>description <span class="op">=</span> <span class="st">"Add your description here"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>readme <span class="op">=</span> <span class="st">"README.md"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>requires<span class="op">-</span>python <span class="op">=</span> <span class="st">"&gt;=3.13"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>dependencies <span class="op">=</span> [</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbt-duckdb&gt;=1.9.1"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbt&gt;=1.0.0.38.22"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"duckdb&gt;=1.1.3"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"great-expectations&gt;=0.18.22"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"jupyter&gt;=1.1.1"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pandas&gt;=2.2.3"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pytest&gt;=8.3.4"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarto&gt;=0.1.0"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="using-.gitignore-effectively" class="level4">
<h4 class="anchored" data-anchor-id="using-.gitignore-effectively">Using .gitignore effectively</h4>
<p>You probably noticed, but when you initialize a project with <code>uv</code> it automatically creates a <code>.gitignore</code> file and populates it with basic files and directories which don’t need to be checked into source control (like .venv). I take this a step further, and add some Quarto specific files and directories too, <code>.quarto</code> and <code>_files</code> folders. Managing this file effectively can drastically reduce the file size of your commits.</p>
<p>Below is an example of my file at this early project stage.</p>
<p><img src="images/gitignore_sample.png" class="img-fluid"></p>
</section>
</section>
<section id="initializing-a-data-environment" class="level3">
<h3 class="anchored" data-anchor-id="initializing-a-data-environment">Initializing a Data Environment</h3>
<p>Now, you’ll be setting up dbt. Similar to the other CLI tools, dbt uses the <code>dbt init</code> command to create the folder structure necessary for the program to be effective. As you can see below, the process is very easy. You’ll only enter a name for your project, which will (case sensitively) become the name of the dbt directory. Next, we’ll walk through the fundamental pieces of a dbt project in depth.</p>
<p><img src="images/dbt_init.png" class="img-fluid"></p>
</section>
<section id="the-data-build-tool-dbt" class="level3">
<h3 class="anchored" data-anchor-id="the-data-build-tool-dbt">The Data Build Tool (dbt)</h3>
<p>As I said, creating a dbt project is easy, but it can get confusing from here on out if you’re alone with the <a href="https://docs.getdbt.com/guides/manual-install?step=1">dbt documentation</a>. In my experience, dbt initalizes a <code>logs/</code> folder in the project root directory <strong>not</strong> the dbt root directory. So, I make sure to add that to the gitignore file, because I don’t think that needs to be checked into version control.</p>
<p>So, now that you’ve initialized your folder, let’s go through the basics:</p>
<section id="project-root-basic_oss" class="level4">
<h4 class="anchored" data-anchor-id="project-root-basic_oss">Project Root: Basic_OSS</h4>
<p>In the case of my project, the root folder is called <code>Basic_OSS</code>. Here, you’ll find the 6 subdirectories, a <code>.gitignore</code> file, a <code>README.md</code> file, and the <code>dbt_project.yml</code> file. The <code>.gitignore</code> can be deleted, because you have one in the project root directory, and for the same reason, so can the README. The dbt project file is the core of your entire data environment, in the same exact way that a <code>_quarto.yml</code> file is the core of your website, book, or documentation project.</p>
<p>This is where you’ll configure the actual structure and hierarchy of your environment, along with things like schemas or variables, or aliases.</p>
</section>
<section id="analyses" class="level4">
<h4 class="anchored" data-anchor-id="analyses">Analyses</h4>
<p>Contains the SQL files for any analysis done that are not part of the core models. Think of these as the <code>SELECT</code> statements for analytical queries, whereas models handle the <code>DDL</code> statements for database architects. Depending on your workflow, this folder could be unused.</p>
</section>
<section id="macros" class="level4">
<h4 class="anchored" data-anchor-id="macros">Macros</h4>
<p>This is where you can store custom macros (functions) and reusable code written in either SQL or <code>jinja</code>. This is the Python package equivalent for SQL and it’s often used to ensure <strong>DRY</strong> (Don’t Repeat Yourself) principles for ETL and other database work.</p>
</section>
<section id="models" class="level4">
<h4 class="anchored" data-anchor-id="models">Models</h4>
<p>This is the core of dbt. Models are the SQL tables themselves, as well as the transformations when cleaning and aggregating data (from raw to reporting). If you have a raw schema (where the raw data is temporarily stored) and a clean schema (where cleaned data is persisted), you would have both a <code>raw</code> and <code>clean</code> folder within the <code>models</code> folder. Then, the individual queries would live within those subfolders as the actual tables and views.</p>
<p>It is where most of (if not all) your transformations live. So, can become computationally taxing if you aren’t careful.</p>
<p>Run with <code>dbt run</code> or <code>dbt run --select {model_directory_name}</code>.</p>
</section>
<section id="seeds" class="level4">
<h4 class="anchored" data-anchor-id="seeds">Seeds</h4>
<p>These are flat files containing static data used for mapping (or reference) data. Only use this if your project needs static data. For more on <a href="https://docs.getdbt.com/reference/seed-configs">seeds</a>.</p>
<p>Run with <code>dbt seed</code>.</p>
</section>
<section id="snapshots" class="level4">
<h4 class="anchored" data-anchor-id="snapshots">Snapshots</h4>
<p>Stores snapshot definitions for versioning and tracking changes in source data over time. These are commonly used for <strong>SCDs</strong> (slowly changing dimensions) or auditing.</p>
<p>Run with <code>dbt snapshot</code>.</p>
</section>
<section id="tests" class="level4">
<h4 class="anchored" data-anchor-id="tests">Tests</h4>
<p>Fairly self explanatory, but this folder contains custom, SQL-defined tests for your models. Dbt allows for both custom tests defined in <code>.sql</code> files and <em>generic</em> tests defined in a <code>YAML</code>. The tests run on various models are defined in the dbt_project.yml file.</p>
</section>
<section id="extra-notes" class="level4">
<h4 class="anchored" data-anchor-id="extra-notes">Extra Notes</h4>
<p>Dbt also has the <code>docs/</code> and <code>dbt_packages/</code> folders which are for advanced documentation and shareable, modularized code, respectively. Generally speaking, your workflow will really only involve the following parts of a dbt project:</p>
<ol type="1">
<li><code>models/</code></li>
<li><code>tests/</code></li>
<li><code>macros/</code></li>
<li><code>dbt_project.yml</code></li>
</ol>
<p>The others are optional and provide functionality, that while useful and powerful in many cases, is not always needed. Now that we’ve got the local directory all configured, it’s time to start building the container for our PostgreSQL instance (server, cluster, whatever you want to call it).</p>
</section>
</section>
</section>
<section id="docker-and-containers" class="level2">
<h2 class="anchored" data-anchor-id="docker-and-containers">Docker and Containers</h2>
<p>Docker is a powerful open-source platform that simplifies the process of developing, packaging, and deploying applications using containers, which are lightweight, portable environments. Unlike traditional virtualization, which replicates an entire computer system, containers virtualize at the operating system (OS) level, creating isolated spaces where applications run with all their dependencies. By isolating apps in containers, Docker ensures that each environment is consistent across different systems, reducing conflicts caused by mismatched dependencies. This approach accelerates development, enhances portability, and enables scalability, making Docker a cornerstone of modern microservices architectures and containerized workflows.</p>
<p>You can learn more about Docker either through their open source <a href="https://docs.docker.com">documentation</a> or DataCamp’s <a href="https://app.datacamp.com/learn/courses/introduction-to-docker">course</a> by Tim Sangster!</p>
<section id="the-dockerfile-and-configuring-your-image" class="level3">
<h3 class="anchored" data-anchor-id="the-dockerfile-and-configuring-your-image">The Dockerfile and Configuring Your Image</h3>
<p>The <code>Dockerfile</code> is the foundation of Docker image creation, serving as a script of instructions to define the environment and behavior of your containerized application. Each instruction in the <code>Dockerfile</code> builds on the previous one, forming layers that together create a Docker image.</p>
<p>A <code>Dockerfile</code> is composed of various instructions, such as:</p>
<ul>
<li><p><strong>FROM</strong>: Specifies the base image to start with. Always begin with this instruction.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> postgres</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>RUN</strong>: Executes shell commands during the build process and creates a new layer.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>COPY/ADD</strong>: Transfers files from your local system into the image.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> postgres-password.txt /usr/home/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>WORKDIR</strong>: Sets the working directory for subsequent instructions.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /usr/home/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>CMD</strong>: Specifies the default command to run when the container starts. Unlike <code>RUN</code>, <code>CMD</code> is executed at runtime.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"postgres"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<section id="optimizing-builds-with-caching" class="level4">
<h4 class="anchored" data-anchor-id="optimizing-builds-with-caching">Optimizing Builds with Caching</h4>
<p>Docker employs a layer-caching mechanism to optimize builds. Each instruction in the <code>Dockerfile</code> forms a layer, and Docker reuses unchanged layers in subsequent builds to save time. For example:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> install <span class="at">-y</span> libpq-dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you rebuild and these instructions remain unchanged, Docker uses cached results. However, if the base image or any instruction changes, the cache is invalidated for that layer and subsequent ones.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Maximize Cache Efficiency">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Maximize Cache Efficiency
</div>
</div>
<div class="callout-body-container callout-body">
<p>Reorder <code>Dockerfile</code> instructions to maximize cache efficiency. Place less frequently changing instructions higher in the file. Then, place the layers you need to test changes in more frequently, lower in the file.</p>
</div>
</div>
</section>
<section id="using-variables-in-dockerfiles" class="level4">
<h4 class="anchored" data-anchor-id="using-variables-in-dockerfiles">Using Variables in Dockerfiles</h4>
<p>Variables make <code>Dockerfiles</code> more flexible and maintainable.</p>
<ul>
<li><p><strong>ARG</strong>: Sets build-time variables.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> APP_PORT=5000</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">"Application port: </span><span class="va">$APP_PORT</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>ARG</code> values are accessible only during the build process.</p></li>
<li><p><strong>ENV</strong>: Sets environment variables for runtime.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> APP_ENV=production</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These variables persist after the image is built and can be overridden when running the container using the <code>--env</code> flag.</p></li>
</ul>
<div class="callout callout-style-default callout-important callout-titled" title="Credentials">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Credentials
</div>
</div>
<div class="callout-body-container callout-body">
<p>Avoid storing sensitive data like credentials in <code>ARG</code> or <code>ENV</code>, as they are visible in the image’s history.</p>
</div>
</div>
</section>
<section id="security-best-practices" class="level4">
<h4 class="anchored" data-anchor-id="security-best-practices">Security Best Practices</h4>
<ol type="1">
<li><p><strong>Use Official Images</strong>: Base your <code>Dockerfile</code> on trusted, well-maintained images from sources like Docker Hub.</p></li>
<li><p><strong>Minimize Packages</strong>: Install only what your application needs to reduce potential vulnerabilities.</p></li>
<li><p><strong>Avoid Root Users</strong>: Run applications with restricted permissions by creating a non-root user:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">useradd</span> <span class="at">-m</span> appuser</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">USER</span> appuser</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Update Regularly</strong>: Keep your base images and software dependencies up to date.</p></li>
</ol>
</section>
</section>
<section id="write-a-postgresql-dockerfile-and-build-the-image" class="level3">
<h3 class="anchored" data-anchor-id="write-a-postgresql-dockerfile-and-build-the-image">Write a PostgreSQL Dockerfile and Build the Image</h3>
<p>Below is an example Dockerfile for setting up PostgreSQL, with specified user, password, and database name:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use an official PostgreSQL base image</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> postgres</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set environment variables from a local file</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> .pg-password /etc/postgresql/.pg-password</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the password from the file and set it as an environment variable</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="va">POSTGRES_PASSWORD</span><span class="op">=</span><span class="va">$(</span><span class="fu">cat</span> /etc/postgresql/.pg-password<span class="va">)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set additional environment variables</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> POSTGRES_USER=chris</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> POSTGRES_DB=test</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Expose the PostgreSQL port</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 5432</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Run commands to configure the environment</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="dt">\</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    libpq-dev <span class="dt">\</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Start PostgreSQL service when the container runs</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"postgres"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For the purposes of simplicity in this guide, I’m just going to leave the POSTGRES_ variables as they are in the file. The password I’ll keep separate to demonstrate how that would work. That being said, after you’ve writen the image’s Dockerfile, you’ll build the image.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> test .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you need to remove the image at any point, first make sure there are no containers using it, then run the following:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> rmi test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="images/docker_build_output.png" class="img-fluid"></p>
</section>
<section id="running-the-container" class="level3">
<h3 class="anchored" data-anchor-id="running-the-container">Running the Container</h3>
<p>Next, to run the container, you’ll be adding a few flags, which I’ll explain below. For simplicity sake, it’s probably easiest to store this in a script somewhere and then execute that on start up. <code>**Note** to myself: Add a section on writing local scripts/executables like this later on in the guide.</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="dt">\</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> pg_test <span class="dt">\</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> POSTGRES_PASSWORD_FILE=/etc/postgresql/.pg-password <span class="dt">\</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> POSTGRES_USER=chris <span class="dt">\</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">-e</span> POSTGRES_DB=test <span class="dt">\</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">-p</span> 5432:5432 <span class="dt">\</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="images/docker_run_output.png" class="img-fluid"></p>
<section id="flags-explained" class="level4">
<h4 class="anchored" data-anchor-id="flags-explained">Flags Explained</h4>
<p>The code above will run a container using the Docker image <code>test</code> as the base.</p>
<ul>
<li>The container will have the <code>--name</code> <strong>pg_test</strong></li>
<li>You’ll use the file located at <code>/etc/postgresql/.pg-password</code> to define the <code>POSTGRES_PASSWORD_FILE</code> environment variable
<ul>
<li>In Docker, when you use the -e option to pass environment variables, you typically use <em>POSTGRES_PASSWORD_FILE</em> instead of <em>POSTGRES_PASSWORD</em> for file-based password configuration because of how Docker processes environment variables and how the underlying system uses them.</li>
</ul></li>
<li>You’ll also pass the <code>-e</code>nvironment variables for <code>POSTGRES_USER</code> and <code>POSTGRES_DB</code>
<ul>
<li>This isn’t necessary because they are defined in the Dockerfile, so they are globally available within the container.</li>
<li>It’s useful to specify these values in the <code>run</code> command if you want to override the default values or pass different values.</li>
<li>Specifying the user and database in the docker run command allows you to control the environment at runtime. More useful in production envrionments, less so for one-off projects like this</li>
</ul></li>
<li>Finally, you’ll map the container’s <code>-p</code>ort 5432 to your <code>port:5432</code></li>
</ul>
</section>
<section id="verifying-a-successful-run" class="level4">
<h4 class="anchored" data-anchor-id="verifying-a-successful-run">Verifying a Successful Run</h4>
<p>To verify your container is running, you can use <code>docker ps</code> to get a list of active containers, their image, and other bits of information.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">CONTAINER</span> ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS                    NAMES</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">5793b64919f0</span>   test      <span class="st">"docker-entrypoint.s…"</span>   14 seconds ago   Up 13 seconds   0.0.0.0:5432-<span class="op">&gt;</span>5432/tcp   pg_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you need to stop the running container, simply type:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> kill pg_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="connecting-to-the-postgresql-server-from-your-command-line-interface" class="level3">
<h3 class="anchored" data-anchor-id="connecting-to-the-postgresql-server-from-your-command-line-interface">Connecting to the PostgreSQL Server from your Command-Line Interface</h3>
<p>Now that the server is up and running, you can test an active connection (and your user permissions) from your CLI. To do so, run the following:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">psql</span> <span class="at">-h</span> localhost <span class="at">-U</span> chris <span class="at">-d</span> test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>psql</code> is the CLI command for postgres, in the same way <code>gh</code> is for GitHub</li>
<li><code>-h</code> tells postgres that the server’s host is <strong><em>localhost</em></strong></li>
<li><code>-U</code> tells postgres to use the <em>user</em> <strong><em>chris</em></strong></li>
<li><code>-d</code> tells postgres to connect to the database <strong><em>test</em></strong></li>
</ul>
<p>You can close that connection at any time by typing <code>\q</code>.</p>
<p><img src="images/psql_conn.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I’m working on a MacOS laptop and manage local packages (like Python, Docker, gh, and Postgres) with Homebrew. Even though I had PostgreSQLv17 installed, it wasn’t added to my PATH for some reason. So, when I ran <code>psql ...</code> I got an error. To fix this, I simply edited the <code>~/.zshrc</code> (the MacOS default terminal <em>zsh</em> configuration file in my home directory) and added <code>export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"</code>.</p>
</div>
</div>
</section>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>